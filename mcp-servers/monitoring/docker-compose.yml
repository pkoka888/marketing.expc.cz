version: '3.8'

services:
  monitoring-mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: monitoring-mcp-server
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - LOG_CONSOLE=true
      - LOG_FILE=false
      - MONITORING_INTERVAL=30
      - MAX_MONITORING_DURATION=3600
      - METRICS_RETENTION=1000
      - ALERTS_RETENTION=100
      - CB_FAILURE_THRESHOLD=5
      - CB_RECOVERY_TIMEOUT=60000
      - CB_MONITORING_TIMEOUT=30000
      - RETRY_MAX_ATTEMPTS=3
      - RETRY_BASE_DELAY=1000
      - RETRY_MAX_DELAY=10000
      - RETRY_BACKOFF_MULTIPLIER=2.0
      - HEALTH_CHECK_ENABLED=true
      - HEALTH_CHECK_PORT=8080
      - HEALTH_CHECK_PATH=/health
      - HEALTH_CHECK_INTERVAL=30000
      - CPU_THRESHOLD=0.8
      - MEMORY_THRESHOLD=0.9
      - DISK_THRESHOLD=0.9
      - DOCKER_ENABLED=true
      - CONTAINER_NAME=monitoring-mcp-server
      - RESTART_POLICY=unless-stopped
    ports:
      - '8080:8080' # Health check port
    volumes:
      - ./logs:/app/logs # Mount logs directory if file logging is enabled
    networks:
      - monitoring-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    labels:
      - 'com.monitoring.service=monitoring-mcp-server'
      - 'com.monitoring.version=2.0.0'

networks:
  monitoring-network:
    driver: bridge
    name: monitoring-network
