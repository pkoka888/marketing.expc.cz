version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres-mcp-db
    environment:
      POSTGRES_DB: marketingportal
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=C --lc-ctype=C'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - '5432:5432'
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d marketingportal']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      postgres
      -c max_connections=100
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.max=10000
      -c pg_stat_statements.track=all

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: postgres-mcp-server
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: marketingportal
      DB_USER: postgres
      DB_PASSWORD: postgres123
      DB_MAX_CONNECTIONS: 20
      DB_IDLE_TIMEOUT: 30000
      DB_CONNECTION_TIMEOUT: 2000
      DB_QUERY_TIMEOUT: 30000

      # Server Configuration
      MCP_SERVER_NAME: postgresql-mcp-server
      MCP_SERVER_VERSION: 1.0.0
      MCP_SERVER_PORT: 3000
      MCP_HEALTH_CHECK_PORT: 3001
      MCP_ENABLE_HEALTH_CHECKS: true

      # Logging Configuration
      LOG_LEVEL: info
      LOG_CONSOLE: true
      LOG_FILE: false
      LOG_FILE_PATH: ./logs/postgresql-mcp.log
      LOG_MAX_FILE_SIZE: 10m
      LOG_MAX_FILES: 5d

      # Circuit Breaker Configuration
      CB_FAILURE_THRESHOLD: 5
      CB_RECOVERY_TIMEOUT: 60000
      CB_MONITORING_PERIOD: 10000

      # Retry Configuration
      RETRY_MAX_ATTEMPTS: 3
      RETRY_BASE_DELAY: 1000
      RETRY_MAX_DELAY: 10000
      RETRY_BACKOFF_MULTIPLIER: 2
      RETRYABLE_ERRORS: ECONNREFUSED,ENOTFOUND,ETIMEDOUT,ECONNRESET,EPIPE,42P01,23505,23503

      # Health Check Configuration
      HEALTH_CHECKS_ENABLED: true
      HEALTH_CHECK_INTERVAL: 30000
      HEALTH_CHECK_TIMEOUT: 5000
      DB_PING_ENABLED: true
      MEMORY_THRESHOLD: 0.9
      CPU_THRESHOLD: 0.8

      # Docker Configuration
      DOCKER_USER: node
      DOCKER_PORT: 3000
      DOCKER_HEALTH_CHECK_PORT: 3001
      NODE_ENV: production
    ports:
      - '3000:3000' # MCP server port
      - '3001:3001' # Health check port
    networks:
      - mcp-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs:/app/logs
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'

  # Optional: pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: postgres-mcp-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@marketingportal.cz
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - '5050:80'
    networks:
      - mcp-network
    depends_on:
      - postgres
    restart: unless-stopped
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  # Optional: Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: postgres-mcp-prometheus
    ports:
      - '9090:9090'
    networks:
      - mcp-network
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  # Optional: Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: postgres-mcp-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_USERS_ALLOW_SIGN_UP: false
    ports:
      - '3002:3000'
    networks:
      - mcp-network
    depends_on:
      - prometheus
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  postgres_data:
  pgadmin_data:
  prometheus_data:
  grafana_data:

networks:
  mcp-network:
    driver: bridge
